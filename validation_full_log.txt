/Users/mar/MIT Dropbox/Marielle Russo/2025_workspace/PrxteinMPNN/.venv/lib/python3.13/site-packages/jax/_src/numpy/reductions.py:232: UserWarning: Explicitly requested dtype <class 'jax.numpy.float64'> requested in sum is not available, and will be truncated to dtype float32. To enable more dtypes, set the jax_enable_x64 configuration option or the JAX_ENABLE_X64 shell environment variable. See https://github.com/jax-ml/jax#current-gotchas for more.
  return _reduction(a, "sum", lax.add, 0, preproc=_cast_to_numeric,
/Users/mar/MIT Dropbox/Marielle Russo/2025_workspace/PrxteinMPNN/.venv/lib/python3.13/site-packages/jax/_src/numpy/reductions.py:165: UserWarning: Explicitly requested dtype <class 'jax.numpy.float64'> requested in convert_element_type is not available, and will be truncated to dtype float32. To enable more dtypes, set the jax_enable_x64 configuration option or the JAX_ENABLE_X64 shell environment variable. See https://github.com/jax-ml/jax#current-gotchas for more.
  return lax.convert_element_type(result, dtype or result_dtype)
===========================================================
   JAX MD vs OpenMM Validation: 1UAO + ff19SB + OBC2
===========================================================

[1] Setting up OpenMM System...
Warning: Using amber14-all.xml. If JAX uses ff19SB, parameters might differ slightly.
OpenMM Total Energy: -248.2369 kcal/mol

[2] Setting up JAX MD System...

[DEBUG] Top 10 Closest Pairs:
  1. 0.9600 A: 97 (OG1) - 102 (HG1)
  2. 0.9600 A: 102 (HG1) - 97 (OG1)
  3. 0.9600 A: 76 (OG1) - 81 (HG1)
  4. 0.9600 A: 81 (HG1) - 76 (OG1)
  5. 0.9601 A: 20 (OH) - 29 (HH)
  6. 0.9601 A: 29 (HH) - 20 (OH)
  7. 0.9762 A: 106 (N) - 120 (H)
  8. 0.9762 A: 120 (H) - 106 (N)
  9. 0.9788 A: 114 (NE1) - 125 (HE1)
  10. 0.9788 A: 125 (HE1) - 114 (NE1)
DEBUG: Using provided gb_radii. Stats: Min=1.2000000476837158, Max=1.7000000476837158
DEBUG: compute_gb_energy called with mask!
DEBUG: Born Radii Min=0.5550000071525574, Max=0.8050000071525574, Mean=0.6754711270332336
DEBUG: Components: Bond=27.177154541015625, Angle=8.71909236907959, Dihedral=121.5749282836914, Improper=0.00038515147753059864, CMAP=0.0, LJ=3048661.25, Elec=-3934.7392578125, NP=0.0
DEBUG: Using provided gb_radii. Stats: Min=1.2000000476837158, Max=1.7000000476837158
DEBUG: compute_gb_energy called with mask!
DEBUG: Born Radii Min=LinearizeTracer<float32[]>, Max=LinearizeTracer<float32[]>, Mean=LinearizeTracer<float32[]>
DEBUG: Components: Bond=LinearizeTracer<float32[]>, Angle=LinearizeTracer<float32[]>, Dihedral=LinearizeTracer<float32[]>, Improper=LinearizeTracer<float32[]>, CMAP=0.0, LJ=LinearizeTracer<float32[]>, Elec=LinearizeTracer<float32[]>, NP=LinearizeTracer<float32[]>
JAX MD Total Energy: 3044884.0000 kcal/mol

[Stage 1] Parameter Validation
Max Charge Diff: 0.785500 (Tol: 1e-4)
Max Sigma Diff:  2.430922 (Tol: 1e-4)
Max Epsilon Diff:0.110000 (Tol: 1e-4)
FAIL: Parameters mismatch.
Max Charge Diff at atom 134 (OXT): -0.7855 vs 0.0

[DEBUG] Overwriting JAX parameters with OpenMM parameters for Energy/Force check...
OpenMM Forces:
 - HarmonicBondForce
 - PeriodicTorsionForce
 - NonbondedForce
 - HarmonicAngleForce
 - CustomGBForce
   CustomGBForce Parameters: 3
    - charge
    - or
    - sr
DEBUG: GB Radii Stats: Min=1.1100, Max=1.6100, Mean=1.3596
DEBUG: Extracted 141 bonds from OpenMM.
DEBUG: Bond (97, 102) found in OpenMM bonds: True
DEBUG: Using provided gb_radii. Stats: Min=1.1100000143051147, Max=1.6100000143051147
DEBUG: Components: Bond=20.41362953186035, Angle=7.9836201667785645, Dihedral=174.75238037109375, Improper=0.0, CMAP=0.0, LJ=54.68016052246094, Elec=-57.787925720214844, NP=0.0
DEBUG: Vacuum Energy (No GBSA): 200.0418 kcal/mol
Recalculating JAX Energy and Forces with Injected Parameters...
DEBUG: Using provided gb_radii. Stats: Min=1.1100000143051147, Max=1.6100000143051147
DEBUG: compute_gb_energy called with mask!
DEBUG: Born Radii Min=0.5099999904632568, Max=0.7599999904632568, Mean=0.6348188519477844
DEBUG: Components: Bond=20.41362953186035, Angle=7.9836201667785645, Dihedral=174.75238037109375, Improper=0.0, CMAP=0.0, LJ=54.68016052246094, Elec=-4339.3330078125, NP=0.0
DEBUG: Using provided gb_radii. Stats: Min=1.1100000143051147, Max=1.6100000143051147
DEBUG: compute_gb_energy called with mask!
DEBUG: Born Radii Min=LinearizeTracer<float32[]>, Max=LinearizeTracer<float32[]>, Mean=LinearizeTracer<float32[]>
DEBUG: Components: Bond=LinearizeTracer<float32[]>, Angle=LinearizeTracer<float32[]>, Dihedral=LinearizeTracer<float32[]>, Improper=0.0, CMAP=0.0, LJ=LinearizeTracer<float32[]>, Elec=LinearizeTracer<float32[]>, NP=LinearizeTracer<float32[]>
JAX MD Total Energy (Recalculated): -4081.5032 kcal/mol

[Stage 2] Energy Component Validation
Component            | OpenMM (kcal/mol)    | JAX (kcal/mol)       | Diff       | Status
-------------------------------------------------------------------------------------
Bond                 |              20.4136 |              20.4136 |    -0.0000 | PASS
Angle                |               7.9836 |               7.9836 |    -0.0000 | PASS
Torsion              |             108.0664 |             174.7524 |   -66.6859 | FAIL
CMAP                 |               0.0000 |               0.0000 |     0.0000 | PASS
NonBonded+GBSA       |            -384.7005 |           -4284.6528 |  3899.9524 | FAIL
-------------------------------------------------------------------------------------
DEBUG: OpenMM NonBonded: -23.2411
DEBUG: OpenMM GBSA: -361.4595
-------------------------------------------------------------------------------------
TOTAL                |            -248.2369 |           -4081.5032 |  3833.2664 | FAIL

[Stage 3] Force Validation
Force RMSE: 7.130139 kcal/mol/A
Force Rel-RMSE: 0.269313
Max Force Error: 20.770254 at atom 62 (CD)
FAIL: Forces mismatch.

[Analysis] Detailed Discrepancy Analysis
Calculated JAX Self-Energy: -4227.3672 kcal/mol
JAX GBSA (Total): -4284.6528 kcal/mol
JAX GBSA (Corrected for Self): -57.2856 kcal/mol
OpenMM GBSA + NonBonded: -384.7005 kcal/mol
Diff (Corrected): -327.4149 kcal/mol

Top 10 Torsion Mismatches:
Idx   | Atoms                | Params (n, phi0, k)       | JAX E      | JAX Phi   
Sum of JAX Torsion Energies: 174.7524
OpenMM Total Torsion: 108.0664
329   | 95-94-106-120        | 1.0, 0.00, 2.00           | 4.0000     | 0.0001    
289   | 88-87-92-99          | 1.0, 0.00, 2.00           | 4.0000     | 0.0005    
146   | 44-56-57-60          | 1.0, 0.00, 2.00           | 4.0000     | -0.0007   
374   | 109-108-130-135      | 1.0, 0.00, 2.00           | 4.0000     | -0.0013   
12    | 3-2-9-21             | 1.0, 0.00, 2.00           | 4.0000     | -0.0016   
49    | 12-11-30-38          | 1.0, 0.00, 2.00           | 4.0000     | 0.0046    
255   | 74-73-85-89          | 1.0, 0.00, 2.00           | 4.0000     | 0.0066    
202   | 59-58-71-78          | 1.0, 0.00, 2.00           | 3.9999     | 0.0072    
151   | 45-44-56-65          | 1.0, 0.00, 2.00           | 3.9999     | 0.0091    
112   | 32-42-48-47          | 1.0, 0.00, 2.00           | 3.9990     | 0.0313    
